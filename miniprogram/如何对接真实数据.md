# 如何对接真实价格数据

## 📊 当前状态

目前小程序使用的是**模拟数据**，包含以下提示：
1. ✅ 首页加载时弹框提示
2. ✅ 更新时间旁边的"模拟数据"标签
3. ✅ 免责声明中的红色高亮提示

## 🎯 对接真实数据的步骤

### 第一步：准备后端API

你需要一个后端接口，返回价格数据：

```javascript
// API 接口示例
GET https://你的域名.com/api/prices

// 返回数据格式
{
  "code": 200,
  "message": "success",
  "data": {
    "updateTime": "2025-11-03 14:32:15",
    "list": [
      {
        "id": 1,
        "code": "gold_9999",
        "name": "黄金9999",
        "subtitle": "Au9999 · 千足金",
        "icon": "Au",
        "iconColor": "#FFD700",
        "buyPrice": 558.50,
        "sellPrice": 568.80,
        "highPrice": 570.20,
        "lowPrice": 556.30
      }
      // ... 其他品种
    ]
  }
}
```

### 第二步：配置服务器域名

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置
3. 服务器域名 → request合法域名
4. 添加你的API域名：`https://你的域名.com`

### 第三步：修改代码

#### 1. 修改 `pages/index/index.js` 的 `loadData` 方法

**找到第49-72行**，替换为：

```javascript
// 加载数据
loadData() {
  wx.showLoading({
    title: '加载中...',
    mask: true
  });

  // 调用后端API获取真实数据
  wx.request({
    url: 'https://你的域名.com/api/prices',
    method: 'GET',
    success: (res) => {
      if (res.data.code === 200) {
        const priceData = res.data.data;
        
        this.setData({
          priceList: priceData.list,
          displayList: priceData.list,
          updateTime: priceData.updateTime
        });
        
        // 可选：缓存数据以便离线使用
        wx.setStorageSync('priceData', priceData);
      } else {
        wx.showToast({
          title: '数据加载失败',
          icon: 'none'
        });
      }
    },
    fail: (err) => {
      console.error('API调用失败:', err);
      wx.showToast({
        title: '网络错误，请重试',
        icon: 'none'
      });
      
      // 失败时使用缓存数据
      const cachedData = wx.getStorageSync('priceData');
      if (cachedData) {
        this.setData({
          priceList: cachedData.list,
          displayList: cachedData.list,
          updateTime: cachedData.updateTime
        });
      }
    },
    complete: () => {
      wx.hideLoading();
      wx.stopPullDownRefresh();
    }
  });
},
```

#### 2. 删除 `app.js` 中的模拟数据方法

打开 `miniprogram/app.js`，**删除或注释掉** `updatePriceData` 方法（第90-220行）。

### 第四步：移除模拟数据提示

#### 1. 删除弹框提示

打开 `pages/index/index.js`：

**删除第38行**：
```javascript
// 删除这一行
this.showMockDataTip();
```

**删除第84-93行**（整个 showMockDataTip 方法）：
```javascript
// 删除整个方法
showMockDataTip() {
  wx.showModal({
    title: '温馨提示',
    content: '当前展示的价格为模拟数据，仅供演示参考。\n\n正式使用前请对接后端API获取真实价格数据。',
    confirmText: '我知道了',
    showCancel: false,
    confirmColor: '#FFA500'
  });
},
```

#### 2. 删除"模拟数据"标签

打开 `pages/index/index.wxml`，**删除第22行**：
```xml
<!-- 删除这一行 -->
<text class="mock-badge">模拟数据</text>
```

#### 3. 修改免责声明

打开 `pages/index/index.wxml`，**删除第136行**：
```xml
<!-- 删除这一行 -->
<text class="disclaimer-item disclaimer-highlight">⚠️ 当前展示的价格为模拟数据，仅供演示参考。正式使用前请对接后端API获取真实价格。</text>
```

### 第五步：测试

1. 保存所有修改
2. 点击"编译"重新运行
3. 检查是否正常显示真实数据
4. 测试下拉刷新功能
5. 测试网络异常情况

## 🔄 完整的数据流程

```
用户打开小程序
    ↓
onLoad 加载
    ↓
loadData() 调用
    ↓
wx.request() 请求API
    ↓
成功 → 显示真实数据 → 缓存到本地
    ↓
失败 → 显示缓存数据 → 提示错误
```

## 💡 高级功能建议

### 1. 自动定时更新

```javascript
onLoad(options) {
  this.loadData();
  this.setStoreInfo();
  
  // 每30秒自动更新一次
  this.updateTimer = setInterval(() => {
    this.loadData();
  }, 30000);
},

onUnload() {
  // 页面卸载时清除定时器
  if (this.updateTimer) {
    clearInterval(this.updateTimer);
  }
}
```

### 2. WebSocket 实时推送

```javascript
onLoad(options) {
  this.loadData();
  this.connectWebSocket();
},

connectWebSocket() {
  wx.connectSocket({
    url: 'wss://你的域名.com/ws/prices'
  });
  
  wx.onSocketMessage((res) => {
    const data = JSON.parse(res.data);
    this.setData({
      priceList: data.list,
      displayList: data.list,
      updateTime: data.updateTime
    });
  });
}
```

### 3. 错误重试机制

```javascript
loadData(retryCount = 0) {
  wx.request({
    url: 'https://你的域名.com/api/prices',
    method: 'GET',
    success: (res) => {
      // 成功处理
    },
    fail: (err) => {
      if (retryCount < 3) {
        // 失败后重试，最多3次
        setTimeout(() => {
          this.loadData(retryCount + 1);
        }, 1000);
      } else {
        wx.showToast({
          title: '数据加载失败',
          icon: 'none'
        });
      }
    }
  });
}
```

## 📝 后端API开发建议

### Node.js + Express 示例

```javascript
const express = require('express');
const app = express();

app.get('/api/prices', (req, res) => {
  // 从数据库或第三方API获取价格
  const priceData = {
    updateTime: new Date().toLocaleString('zh-CN'),
    list: [
      {
        id: 1,
        code: 'gold_9999',
        name: '黄金9999',
        subtitle: 'Au9999 · 千足金',
        icon: 'Au',
        iconColor: '#FFD700',
        buyPrice: 558.50,
        sellPrice: 568.80,
        highPrice: 570.20,
        lowPrice: 556.30
      }
      // ... 其他品种
    ]
  };
  
  res.json({
    code: 200,
    message: 'success',
    data: priceData
  });
});

app.listen(3000);
```

### Java + Spring Boot 示例

```java
@RestController
@RequestMapping("/api")
public class PriceController {
    
    @GetMapping("/prices")
    public ResponseEntity<ApiResponse> getPrices() {
        PriceData priceData = priceService.getCurrentPrices();
        
        return ResponseEntity.ok(
            new ApiResponse(200, "success", priceData)
        );
    }
}
```

## ⚠️ 注意事项

### 1. 数据安全
- 使用HTTPS加密传输
- 添加接口签名验证
- 设置访问频率限制

### 2. 性能优化
- 使用CDN加速
- 启用HTTP缓存
- 压缩响应数据

### 3. 容错处理
- 提供缓存机制
- 设置请求超时
- 友好的错误提示

### 4. 合规要求
- 确保数据来源合法
- 添加免责声明
- 符合金融类小程序规范

## 🔍 测试清单

上线前请确认：
- [ ] API接口可以正常访问
- [ ] 数据格式正确
- [ ] 服务器域名已配置
- [ ] 网络异常时有友好提示
- [ ] 缓存机制正常工作
- [ ] 下拉刷新可以更新数据
- [ ] 所有模拟数据提示已移除
- [ ] 价格更新及时准确

## 📞 需要帮助？

如果在对接过程中遇到问题，请检查：
1. 网络请求的URL是否正确
2. 服务器域名是否已配置
3. API返回的数据格式是否匹配
4. 控制台是否有错误信息

---

**提示**：对接真实数据后，建议先在测试环境充分测试，确认无误后再发布到生产环境。

