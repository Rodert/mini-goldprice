# 🔧 预约管理菜单不显示 - 问题排查指南

## 📋 问题现象

登录后台管理系统后，在左侧菜单栏看不到"预约管理"菜单。

---

## 🔍 原因分析

### 核心原因

数据库初始化代码有一个检查机制：

```go
// models/init.go 第82-88行
var count int64
DB.Model(&AdminUser{}).Count(&count)
if count > 0 {
    log.Println("数据库已有数据，跳过初始化")
    return nil  // ← 这里会跳过所有菜单初始化
}
```

**如果数据库中已经有用户数据，初始化流程会被跳过，导致新菜单无法添加！**

### 可能的场景

1. **首次启动时没有完整初始化** - 数据库部分创建后中断
2. **代码更新后新增了菜单** - 旧数据库没有新菜单
3. **手动删除了部分数据** - 菜单权限丢失

---

## ✅ 解决方案

### 方案1：完全重新初始化数据库（推荐）⭐

**优点**：确保所有数据都是最新的
**缺点**：会清空所有现有数据（用户、角色、预约等）

#### 步骤：

```bash
# 进入后端目录
cd gold-admin-backend

# 执行重新初始化脚本
./重新初始化数据库.sh
```

**脚本会自动：**
1. ✅ 停止后端服务
2. ✅ 备份旧数据库（保存到 `data/gold_admin.db.backup_时间戳`）
3. ✅ 删除旧数据库
4. ✅ 重启后端（自动创建新数据库并初始化所有数据）

#### 初始化后的默认数据：

```
管理员账号：
  用户名: admin
  密码: admin123
  角色: 超级管理员（拥有所有权限）

包含菜单：
  ├─ 首页
  ├─ 业务管理
  │  ├─ 价格管理
  │  ├─ 预约管理  ← 包含这个
  │  └─ 店铺管理
  └─ 系统管理
     ├─ 用户管理
     ├─ 角色管理
     └─ 菜单管理
```

---

### 方案2：手动添加菜单（保留现有数据）

**优点**：保留所有现有数据
**缺点**：只添加预约管理菜单，其他可能缺失的菜单不会补充

#### 步骤：

```bash
# 进入后端目录
cd gold-admin-backend

# 执行手动添加菜单脚本
./手动添加菜单.sh
```

**脚本会自动：**
1. ✅ 检查数据库文件
2. ✅ 添加"业务管理"目录（如果不存在）
3. ✅ 添加"预约管理"菜单
4. ✅ 为超级管理员角色分配权限

#### 完成后：

1. **重启后端服务**
   ```bash
   # 停止后端
   pkill -f "go run main.go"
   
   # 重新启动
   go run main.go
   ```

2. **清除前端缓存**
   - 方法1：浏览器按 `Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac) 强制刷新
   - 方法2：退出登录，重新登录
   - 方法3：清除浏览器缓存

---

### 方案3：手动使用 SQLite 命令行（高级）

如果脚本无法执行，可以手动操作：

```bash
# 1. 进入数据库
cd gold-admin-backend
sqlite3 ./data/gold_admin.db

# 2. 查看现有菜单
SELECT * FROM menus;

# 3. 查看是否有预约管理菜单
SELECT * FROM menus WHERE name = 'appointment';

# 4. 如果没有，执行添加（复制整个SQL块）
INSERT OR IGNORE INTO menus (id, parent_id, type, name, title, icon, path, component, sort, visible, status, created_at, updated_at)
VALUES (12, 10, 2, 'appointment', '预约管理', 'el-icon-date', 'appointment', 'appointment/index', 2, 1, 1, datetime('now'), datetime('now'));

# 5. 添加权限关联
INSERT OR IGNORE INTO role_menus (role_id, menu_id, created_at)
VALUES (1, 12, datetime('now'));

# 6. 退出
.quit
```

---

## 🔍 验证是否成功

### 1. 检查后端日志

启动后端时应该看到：

```
✓ 创建默认角色完成
✓ 创建默认菜单完成
✓ 为超级管理员分配菜单完成
...
服务器启动成功，监听地址: :8080
```

### 2. 检查数据库

```bash
# 查看菜单表
sqlite3 ./data/gold_admin.db "SELECT id, title, path FROM menus;"

# 应该包含：
# 12|预约管理|appointment
```

### 3. 测试API

```bash
# 登录获取token
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 复制返回的token，然后获取菜单
curl http://localhost:8080/api/user/menus \
  -H "Authorization: Bearer <你的token>"

# 返回的JSON中应该包含预约管理菜单
```

### 4. 前端验证

1. **退出登录**
2. **清除浏览器缓存**（重要！）
3. **重新登录**
4. **查看左侧菜单栏**

应该看到：

```
┌─────────────────┐
│ 首页            │
├─────────────────┤
│ 业务管理  ▼     │
│   价格管理      │
│   预约管理  ←✓  │
│   店铺管理      │
├─────────────────┤
│ 系统管理  ▼     │
│   用户管理      │
│   角色管理      │
│   菜单管理      │
└─────────────────┘
```

---

## ⚠️ 常见问题

### Q1: 脚本执行后还是看不到菜单？

**A**: 清除浏览器缓存或退出重新登录！前端会缓存菜单数据。

```bash
# Chrome/Firefox
Ctrl+Shift+Del (Windows)
Cmd+Shift+Del (Mac)

# 或者直接退出登录重新登录
```

### Q2: 提示"数据库文件不存在"？

**A**: 需要先启动一次后端服务创建数据库。

```bash
cd gold-admin-backend
go run main.go
```

### Q3: 只想看某个用户的菜单权限？

**A**: 使用SQL查询：

```bash
sqlite3 ./data/gold_admin.db

# 查看用户1的所有菜单
SELECT m.* FROM menus m
JOIN role_menus rm ON m.id = rm.menu_id
JOIN user_roles ur ON rm.role_id = ur.role_id
WHERE ur.user_id = 1;
```

### Q4: 重新初始化后原有数据会丢失吗？

**A**: 
- ✅ 脚本会自动备份旧数据库
- 📁 备份文件在 `data/gold_admin.db.backup_时间戳`
- 🔄 可以手动恢复：`cp data/gold_admin.db.backup_xxx data/gold_admin.db`

### Q5: 我添加了其他用户，他们也看不到菜单？

**A**: 检查该用户是否分配了角色，以及角色是否有菜单权限。

在系统管理 → 用户管理中：
1. 编辑用户
2. 分配角色（如：超级管理员）
3. 保存

---

## 🎯 推荐流程

### 开发环境（可以丢失数据）

使用**方案1** - 完全重新初始化
```bash
cd gold-admin-backend
./重新初始化数据库.sh
```

### 生产环境（不能丢失数据）

使用**方案2** - 手动添加菜单
```bash
cd gold-admin-backend
./手动添加菜单.sh
# 然后重启后端和清除前端缓存
```

---

## 📝 预防措施

### 1. 改进初始化逻辑

如果需要在已有数据的情况下补充新菜单，可以修改 `models/init.go`：

```go
// 方案A：分别检查每个表
func InitData() error {
    // 检查并初始化角色
    var roleCount int64
    DB.Model(&Role{}).Count(&roleCount)
    if roleCount == 0 {
        // 创建角色...
    }
    
    // 检查并初始化菜单
    var menuCount int64
    DB.Model(&Menu{}).Count(&menuCount)
    if menuCount == 0 {
        // 创建菜单...
    }
    
    // ...
}
```

### 2. 使用数据库迁移工具

推荐使用 `golang-migrate` 等工具管理数据库变更：

```bash
# 创建迁移文件
migrate create -ext sql -dir migrations add_appointment_menu

# 执行迁移
migrate -path migrations -database sqlite3://./data/gold_admin.db up
```

---

## 📞 需要帮助？

如果以上方案都无法解决问题，请提供以下信息：

1. 后端启动日志
2. 前端控制台错误（F12查看）
3. `SELECT * FROM menus;` 的查询结果
4. `SELECT * FROM role_menus WHERE menu_id=12;` 的查询结果

---

**创建日期**: 2025-11-05  
**版本**: v1.0

