# ❌ 问题：新建用户时无法选择角色

## 🔍 问题诊断

### 可能的原因

1. ✅ **角色数据未初始化** - 数据库中没有角色数据
2. ✅ **API接口异常** - 角色列表接口返回失败
3. ✅ **前端组件问题** - 角色选择组件未正确加载数据

---

## 🛠️ 排查步骤

### 步骤1: 检查角色数据是否存在

```bash
# 进入数据库
sqlite3 ./data/gold_admin.db

# 查询角色表
SELECT * FROM roles;

# 退出
.quit
```

**预期结果**：应该看到5个角色
```
1|超级管理员|super_admin|拥有所有权限|1|1|...
2|总部店长|head_manager|管理所有店铺|2|1|...
3|单店店长|shop_manager|管理单个店铺|3|1|...
4|店员|shop_staff|处理日常业务|4|1|...
5|财务|finance|查看数据、导出报表|5|1|...
```

---

### 步骤2: 测试API接口

```bash
# 获取 token
TOKEN=$(curl -s -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.data.token')

# 测试获取所有角色接口
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/roles/all | jq
```

**预期结果**：
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "name": "超级管理员",
      "code": "super_admin",
      "status": 1
    },
    ...
  ],
  "message": "success"
}
```

---

### 步骤3: 检查前端控制台

1. 打开浏览器 DevTools (F12)
2. 访问用户管理页面
3. 点击"新增用户"
4. 查看 Console 是否有错误
5. 查看 Network 标签，检查 `/api/roles/all` 请求

---

## ✅ 解决方案

### 方案1: 重新初始化数据库（推荐）

```bash
# 停止后端服务
pkill -f "go run main.go"

# 删除数据库文件
rm -f ./data/gold_admin.db

# 重新启动服务（会自动初始化）
go run main.go
```

**结果**: 数据库会重新创建，包含所有初始数据

---

### 方案2: 手动插入角色数据

如果不想删除数据库，可以手动插入：

```bash
sqlite3 ./data/gold_admin.db << 'EOF'
INSERT INTO roles (name, code, description, sort, status, created_at, updated_at)
VALUES
  ('超级管理员', 'super_admin', '拥有所有权限', 1, 1, datetime('now'), datetime('now')),
  ('总部店长', 'head_manager', '管理所有店铺', 2, 1, datetime('now'), datetime('now')),
  ('单店店长', 'shop_manager', '管理单个店铺', 3, 1, datetime('now'), datetime('now')),
  ('店员', 'shop_staff', '处理日常业务（只读）', 4, 1, datetime('now'), datetime('now')),
  ('财务', 'finance', '查看数据、导出报表', 5, 1, datetime('now'), datetime('now'));
EOF
```

---

### 方案3: 使用初始化脚本

创建并运行初始化脚本：

```bash
#!/bin/bash
# init_roles.sh

BASE_URL="http://localhost:8080/api"

# 登录获取 token
TOKEN=$(curl -s -X POST "$BASE_URL/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.data.token')

# 创建角色
roles=(
  '{"name":"超级管理员","code":"super_admin","description":"拥有所有权限","sort":1,"status":1}'
  '{"name":"总部店长","code":"head_manager","description":"管理所有店铺","sort":2,"status":1}'
  '{"name":"单店店长","code":"shop_manager","description":"管理单个店铺","sort":3,"status":1}'
  '{"name":"店员","code":"shop_staff","description":"处理日常业务","sort":4,"status":1}'
  '{"name":"财务","code":"finance","description":"查看数据、导出报表","sort":5,"status":1}'
)

for role in "${roles[@]}"; do
  curl -s -X POST "$BASE_URL/roles" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $TOKEN" \
    -d "$role" | jq '.message'
done

echo "角色初始化完成！"
```

运行：
```bash
chmod +x init_roles.sh
./init_roles.sh
```

---

## 🎯 验证修复

### 1. 测试API

```bash
# 获取所有角色
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/roles/all | jq '.data | length'
```

**预期输出**: `5` （表示有5个角色）

### 2. 测试前端

1. 刷新浏览器页面
2. 点击"系统管理" → "用户管理"
3. 点击"新增用户"
4. 查看"角色"下拉框，应该能看到5个角色选项

### 3. 测试创建用户

```bash
# 创建用户并分配角色
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "username": "test_user",
    "password": "123456",
    "real_name": "测试用户",
    "status": 1,
    "role_ids": [3]
  }' | jq
```

**预期结果**: 
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 2,
    "username": "test_user",
    ...
  }
}
```

---

## 📋 完整测试脚本

保存为 `test_role_selection.sh`：

```bash
#!/bin/bash

echo "================================"
echo "用户角色选择问题 - 完整测试"
echo "================================"
echo ""

BASE_URL="http://localhost:8080/api"

# 1. 登录
echo "1. 登录系统..."
TOKEN=$(curl -s -X POST "$BASE_URL/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq -r '.data.token')

if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
  echo "❌ 登录失败！"
  exit 1
fi
echo "✓ 登录成功"
echo ""

# 2. 检查角色列表
echo "2. 检查角色列表..."
role_count=$(curl -s -H "Authorization: Bearer $TOKEN" \
  "$BASE_URL/roles/all" | jq '.data | length')

echo "角色数量: $role_count"
if [ "$role_count" -eq 0 ]; then
  echo "❌ 角色数据为空！"
  echo ""
  echo "解决方案："
  echo "1. 删除数据库重新初始化: rm -f ./data/gold_admin.db && go run main.go"
  echo "2. 或运行角色初始化脚本"
  exit 1
else
  echo "✓ 角色数据正常"
fi
echo ""

# 3. 显示所有角色
echo "3. 角色列表详情..."
curl -s -H "Authorization: Bearer $TOKEN" \
  "$BASE_URL/roles/all" | jq '.data[] | {id, name, code}'
echo ""

# 4. 测试创建用户
echo "4. 测试创建用户..."
result=$(curl -s -X POST "$BASE_URL/users" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "username": "test_role_'$(date +%s)'",
    "password": "123456",
    "real_name": "测试用户",
    "status": 1,
    "role_ids": [3]
  }')

echo "$result" | jq
code=$(echo "$result" | jq -r '.code')

if [ "$code" == "200" ]; then
  echo "✓ 创建用户成功，角色分配正常"
  user_id=$(echo "$result" | jq -r '.data.id')
  
  # 验证用户角色
  echo ""
  echo "5. 验证用户角色..."
  curl -s -H "Authorization: Bearer $TOKEN" \
    "$BASE_URL/users/$user_id" | jq '.data.role_ids'
else
  echo "❌ 创建用户失败"
fi

echo ""
echo "================================"
echo "测试完成！"
echo "================================"
```

运行测试：
```bash
chmod +x test_role_selection.sh
./test_role_selection.sh
```

---

## 🐛 常见错误和解决

### 错误1: 角色下拉框为空

**原因**: 角色数据未初始化

**解决**: 
```bash
# 重新初始化数据库
rm -f ./data/gold_admin.db
go run main.go
```

### 错误2: 401 Unauthorized

**原因**: Token 过期或未登录

**解决**: 
- 重新登录获取新 Token
- 检查请求头是否正确携带 Token

### 错误3: CORS 错误

**原因**: 跨域配置问题

**解决**: 检查后端 `middleware/cors.go` 配置

### 错误4: 网络请求失败

**原因**: 后端服务未启动

**解决**:
```bash
# 检查服务是否运行
lsof -i :8080

# 启动服务
go run main.go
```

---

## 📞 仍然无法解决？

### 收集诊断信息

```bash
# 1. 检查数据库
echo "=== 角色表数据 ==="
sqlite3 ./data/gold_admin.db "SELECT * FROM roles;"

# 2. 检查后端日志
echo "=== 后端日志 ==="
tail -50 ./logs/*.log

# 3. 测试API
echo "=== API 测试 ==="
curl -v http://localhost:8080/api/roles/all

# 4. 检查服务状态
echo "=== 服务状态 ==="
ps aux | grep "go run main.go"
lsof -i :8080
```

### 联系支持

提供以上诊断信息：
- 数据库查询结果
- 后端日志
- API 测试结果
- 浏览器控制台截图

---

**文档版本**: v1.0.0  
**最后更新**: 2025-11-04  
**问题状态**: 可修复














